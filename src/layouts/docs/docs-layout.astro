---
import type { Props as DocProps } from '@astropub/doc'

import { getSecondaryNavGroup } from 'project:components/site-navigation/server/currentPath.js'

import Layout from 'project:layouts/default/default-layout.astro'
import SiteSkipTo from 'project:components/site-skipto/site-skipto.astro'
import PageHeader from 'project:components/page-header/page-header.js'
import PageAside from 'project:components/page-aside/page-aside.astro'
import ContributionFooter from 'project:components/contribution-footer/contribution-footer.astro'
import FeedbackWidget from 'project:components/feedback-widgets/feedback-widget-sticky/feedback-widget.astro'
import globalData from 'project:data/global.json'

import './docs-layout.css'
import { protectedRoutes } from 'project:data/protected-routes'

export interface Props extends DocProps {
	content: {
		draft?: boolean
		title: string
		subtitle?: string
		description?: string
		url?: string
		status?: string
	}
	file?: string
}

const { content } = Astro.props
const title = content.subtitle ? `${content.title} ${content.subtitle}` : content.title
const tabTitle = content.title
const description = content.description || false
const url = content.url
const draft = content.draft ? content.draft : false

// Route-based protection logic
const pathname = Astro.url.pathname
const isProtectedRoute = protectedRoutes.some(route => pathname.startsWith(route))

const authMessage = 'No marketing or emails. Just access to the premier Aerospace design system.'

/* Create github link to source file */

/** RegEx to match a slash (/) at the end ($) of a string. */
const matchTrailingSlash = /\/$/

/** Removes the trailing slash from a string. */
const withoutTrailingSlash = (value: string) => value.replace(matchTrailingSlash, '')

/* grab the source file url and then get the extension */
const fileURL = new URL(Astro.props.file!, 'file:').toString()
let fileExt = fileURL.split('.').at(-1)

/* test the file name against the file URL */
const fileNoExt = fileURL.split('.').at(0)
const fileName = fileNoExt?.split('/').at(-1)
const finalURLSeg = withoutTrailingSlash(Astro.url.pathname).split('/').at(-1)
const gitURL = fileName !== finalURLSeg ? `${Astro.url.pathname}${fileName}.${fileExt === 'mjs' ? 'astro' : fileExt}` : `${withoutTrailingSlash(Astro.url.pathname)}.${fileExt === 'mjs' ? 'astro' : fileExt}`

/** URL to the current source for this page. */
const githubSourceURL = `${globalData.designSystem.repository}/tree/${globalData.designSystem.repositoryBranch}/src/pages${gitURL}`

---
<Layout title={title} tabtitle={tabTitle} description?={description}>
	{draft ? <meta slot="head" name="robots" content="noindex, nofollow" /> : null }
	<SiteSkipTo slot="top" />

	<main class="page" id="content">
		<PageHeader slot="header">
			<PageHeader.Heading status={content.status || null}>
				{content.title}
			</PageHeader.Heading>
			<PageHeader.Subheading>
				{content.description ? content.description : null}
			</PageHeader.Subheading>
			<div class="nav-holder">
			{
				getSecondaryNavGroup(Astro.url.pathname)
					? (
						<PageHeader.Nav file={Astro.props.file} />
					)
				: null
			}
			</div>
		</PageHeader>


		<div class="page-toolbar">
			<slot name="toolbar" />
		</div>

		<div class="page-content">
			<div class="page-content-main-col">
				{isProtectedRoute ? (
					<div class="secure-content-loader" data-secure-loader data-auth-message={authMessage}>
						<!-- Loading state -->
						<div class="auth-loading" data-loading-state>
							<div class="loading-spinner">
								<div class="spinner"></div>
								<p>Checking authentication...</p>
							</div>
						</div>

						<!-- Login required state -->
						<div class="login-required" data-login-state style="display: none;">
							<div class="login-prompt">
								<h2>Sign in to Continue</h2>
								<p>{authMessage}</p>
								<button class="login-btn" data-login-trigger>Sign In</button>
							</div>
						</div>

						<!-- Protected content will be loaded here -->
						<div class="protected-content" data-protected-content style="display: none;">
							<!-- Content loaded dynamically after auth check -->
						</div>

						<!-- Store the original content in a template not included in the DOM -->
						<template data-original-content>
							<slot />
							<ContributionFooter sourceurl={githubSourceURL} />
						</template>
					</div>
				) : (
					<>
						<slot />
						<ContributionFooter sourceurl={githubSourceURL} />
					</>
				)}
			</div>

			<aside class="page-content-side-col" id="aside">
				<div class="-content">
					<slot name="aside"><PageAside {...Astro.props} protectedRoutes={protectedRoutes} /></slot>
				</div>
			</aside>
		</div>
	</main>
	<FeedbackWidget currentURL={Astro.url.pathname} />
</Layout>
<script>
	import './docs-layout.client'
	import 'project:components/color-swab-custom-element.ts'
</script>

<script>
	// @ts-nocheck
	// Secure content loading for protected routes
	document.addEventListener('DOMContentLoaded', async () => {
		const secureLoaders = document.querySelectorAll('[data-secure-loader]')

		secureLoaders.forEach(async (loader) => {
			const loadingEl = loader.querySelector('[data-loading-state]')
			const loginEl = loader.querySelector('[data-login-state]')
			const contentEl = loader.querySelector('[data-protected-content]')
			const templateEl = loader.querySelector('[data-original-content]')
			const loginBtn = loader.querySelector('[data-login-trigger]')

			// Handle login button
			if (loginBtn) {
				loginBtn.addEventListener('click', async () => {
					try {
						const { default: authManager } = await import('project:utils/auth-client.js')
						await authManager.login()
						// After login, re-check auth and load content
						setTimeout(() => checkAuthAndLoadContent(), 1000)
					} catch (error) {
						console.error('Login error:', error)
					}
				})
			}

			async function checkAuthAndLoadContent() {
				try {
					// Show loading
					showElement(loadingEl)
					hideElement(loginEl)
					hideElement(contentEl)

					// Import and check auth
					const { default: authManager } = await import('project:utils/auth-client.js')
					await authManager.init()

					if (authManager.isAuthenticated) {
						// Load the protected content from template
						if (templateEl && contentEl) {
							const template = templateEl instanceof HTMLTemplateElement ? templateEl : null
							if (template) {
								const content = template.content.cloneNode(true)
								contentEl.innerHTML = ''
								contentEl.appendChild(content)
							}

							// Update user info elements
							const userElements = contentEl.querySelectorAll('[data-auth-user]')
							userElements.forEach(el => {
								if (authManager.user) {
									el.textContent = authManager.user.name || authManager.user.email || 'User'
								}
							})
						}

						// Show protected content
						hideElement(loadingEl)
						hideElement(loginEl)
						showElement(contentEl)
					} else {
						// Show login required with preview
						// Create preview container if it doesn't exist
						let previewNode = loader.querySelector('.protected-preview-html')
						if (!previewNode && templateEl instanceof HTMLTemplateElement) {
							previewNode = document.createElement('div')
							previewNode.className = 'protected-preview-html'

							// Apply inline styles as backup to ensure they work
							previewNode.style.cssText = `
							position: relative;
							filter: blur(3px);
							-webkit-filter: blur(3px);
							opacity: 0.6;
							pointer-events: none;
							display: block;
							text-align: left;
							padding: 2rem;
						`

						// Clone the full template content
						const fullClone = templateEl.content.cloneNode(true)
							const container = document.createElement('div')
							container.appendChild(fullClone)

							// Remove scripts
							Array.from(container.querySelectorAll('script')).forEach(n => n.remove())

							// Get only first few block-level elements for preview
							const blockElements = Array.from(container.querySelectorAll('p, h1, h2, h3, h4, h5, h6, ul, ol, pre, blockquote, div.component, section'))
							const maxElements = 5 // Show only first 5 block elements

							// Append only the first few elements to preview
							blockElements.slice(0, maxElements).forEach(el => {
								previewNode.appendChild(el.cloneNode(true))
							})

							// Add a fade indicator at the bottom
							const fadeIndicator = document.createElement('div')
							fadeIndicator.style.cssText = `
							height: 4rem;
							background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
							margin-top: -4rem;
							position: relative;
							pointer-events: none;
						`
						previewNode.appendChild(fadeIndicator)

							// Add preview after login prompt
							loader.appendChild(previewNode)
						}

						hideElement(loadingEl)
						hideElement(contentEl)
						showElement(loginEl)
						if (previewNode) showElement(previewNode)
					}
				} catch (error) {
					console.error('Auth check error:', error)
					// Show login on error
					hideElement(loadingEl)
					hideElement(contentEl)
					showElement(loginEl)
				}
			}

			function showElement(el) {
				if (el) el.style.display = 'block'
			}

			function hideElement(el) {
				if (el) el.style.display = 'none'
			}

			// Initial check
			checkAuthAndLoadContent()

			// Listen for auth state changes
			window.addEventListener('authStateChanged', checkAuthAndLoadContent)
		})
	})
</script>

<style>
    /* Styles for the secure content loader */
    .secure-content-loader {
        position: relative;
        min-height: 200px;
    }

    .auth-loading {
        text-align: center;
        padding: 2rem;
    }

    /* Float the login prompt on top of blurred content */
    .login-required {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        text-align: center;
        max-width: 500px;
        width: 90%;
    }

    .protected-content {
        padding: 2rem;
    }

    /* HTML preview - styled to match protected-content but blurred and truncated */
    .protected-preview-html {
        /* Reset centering from login-required */
        text-align: left;
        padding: 2rem;
        /* Visual effects */
        position: relative;
        filter: blur(3px) !important;
        -webkit-filter: blur(3px) !important;
        opacity: 0.6 !important;
        pointer-events: none;
        /* Ensure it displays */
        display: block !important;
        /* Give it enough height to show content behind the overlay */
        min-height: 600px;
    }

    .loading-spinner .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #000;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem auto;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .login-prompt h2 {
        margin-bottom: 0.5rem;
		margin-top: 1rem;
        color: var(--ColorTextPrimary, #333);
    }

    .login-prompt p {
        margin-bottom: 1rem;
        color: var(--Grey600Color);
    }

    .login-btn {
        background-color: var(--InteractiveColor);
        color: var(--InverseColor);
        border: 1px solid var(--InteractiveColor);
        padding: 0.75rem 1.5rem;
        border-radius: var(--EdgeRadius);
        cursor: pointer;
        font-size: 1rem;
    }

    .login-btn:hover {
        background-color: var(--InteractiveHoverColor);
        border-color: var(--InteractiveHoverColor);
    }
</style>