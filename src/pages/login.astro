---
import DefaultLayout from 'project:layouts/default/default-layout.astro'
import PageHeader from 'project:components/page-header/page-header.astro'

const redirectUrl = Astro.url.searchParams.get('redirect') || '/'
---

<DefaultLayout title="Sign In - Astro UXDS" tabtitle="Sign In">
  <main class="page" id="content">
    <PageHeader>
      <h1>Sign In</h1>
      <p>Access premium components and documentation</p>
    </PageHeader>

    <div class="page-content">
      <div class="auth-container">
        <form id="loginForm" class="auth-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="form-control"
              placeholder="you@example.com"
            />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="form-control"
              placeholder="Your password"
            />
          </div>

          <div id="error-message" class="alert alert-error" style="display: none;"></div>

          <button type="submit" class="btn btn-primary">
            Sign In
          </button>

          <div class="auth-links">
            <a href="/signup/">Create an account</a>
            <a href="/forgot-password/">Forgot password?</a>
          </div>
        </form>
      </div>
    </div>
  </main>
</DefaultLayout>

<style>
  .auth-container {
    max-width: 400px;
    margin: 2rem auto;
    padding: 2rem;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .form-control {
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
  }

  .btn-primary {
    padding: 0.75rem 1.5rem;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-base);
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
  }

  .auth-links {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
    font-size: 0.875rem;
  }

  .alert {
    padding: 0.75rem;
    border-radius: var(--radius-base);
  }

  .alert-error {
    background: var(--color-error-light);
    color: var(--color-error);
    border: 1px solid var(--color-error);
  }
</style>

<script define:vars={{ redirectUrl }} type="module">
  // Import Firebase auth functions via our helper (keeps pages simple)
  import { signInWithEmailAndPassword } from '../../lib/firebase-auth.js'

  // Validate redirect path to prevent open-redirect attacks
  const safeRedirect = (raw) => {
    if (typeof raw !== 'string') return '/'
    // Disallow protocols and protocol-relative URLs
    if (/^([a-z]+:)?\/\//i.test(raw)) return '/'
    // Must start with a single slash
    return raw.startsWith('/') ? raw : '/'
  }

  // Convert Firebase error codes into friendly messages
  const getAuthErrorMessage = (err) => {
    const code = (err && typeof err === 'object' && 'code' in err) ? err.code : ''
    switch (code) {
      case 'auth/invalid-email':
        return 'Please enter a valid email address.'
      case 'auth/user-disabled':
        return 'This account has been disabled.'
      case 'auth/user-not-found':
      case 'auth/wrong-password':
        return 'Incorrect email or password.'
      case 'auth/too-many-requests':
        return 'Too many attempts. Please try again later.'
      default:
        return 'Sign-in failed. Please try again.'
    }
  }

  // Setup form handler with null/type checks for safety
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('loginForm')
    if (!(form instanceof HTMLFormElement)) return

    const errorDiv = document.getElementById('error-message')

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const formData = new FormData(form)
      const email = formData.get('email')
      const password = formData.get('password')

      try {
        await signInWithEmailAndPassword(String(email || ''), String(password || ''))
        // Redirect (validated)
        window.location.href = safeRedirect(redirectUrl)
      } catch (error) {
        const msg = getAuthErrorMessage(error)
        if (errorDiv instanceof HTMLElement) {
          errorDiv.textContent = msg
          errorDiv.style.display = 'block'
        }
      }
    })
  })
</script>