---
import DefaultLayout from 'project:layouts/default/default-layout.astro'
import PageHeader from 'project:components/page-header/page-header.astro'
---

<DefaultLayout title="Sign Up - Astro UXDS" tabtitle="Sign Up">
  <main class="page" id="content">
    <PageHeader>
      <h1>Create Account</h1>
      <p>Join the Astro UXDS community and access premium content</p>
    </PageHeader>

    <div class="page-content">
      <div class="auth-container">
        <form id="signupForm" class="auth-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="form-control"
              placeholder="you@example.com"
            />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="form-control"
              placeholder="At least 8 characters"
              minlength="8"
            />
          </div>

          <div class="form-group">
            <label for="organization">Organization (Optional)</label>
            <input
              type="text"
              id="organization"
              name="organization"
              class="form-control"
              placeholder="Your company or organization"
            />
          </div>

          <div class="form-group">
            <label for="role">Role (Optional)</label>
            <select id="role" name="role" class="form-control">
              <option value="">Select your role</option>
              <option value="developer">Developer</option>
              <option value="designer">Designer</option>
              <option value="product-manager">Product Manager</option>
              <option value="researcher">UX Researcher</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div id="error-message" class="alert alert-error" style="display: none;"></div>
          <div id="success-message" class="alert alert-success" style="display: none;"></div>

          <button type="submit" class="btn btn-primary">
            Create Account
          </button>

          <div class="auth-links">
            <a href="/login/">Already have an account? Sign in</a>
          </div>
        </form>
      </div>
    </div>
  </main>
</DefaultLayout>

<style>
  .auth-container {
    max-width: 400px;
    margin: 2rem auto;
    padding: 2rem;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .form-control {
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
  }

  .btn-primary {
    padding: 0.75rem 1.5rem;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-base);
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
  }

  .auth-links {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
    font-size: 0.875rem;
  }

  .alert {
    padding: 0.75rem;
    border-radius: var(--radius-base);
  }

  .alert-error {
    background: var(--color-error-light);
    color: var(--color-error);
    border: 1px solid var(--color-error);
  }

  .alert-success {
    background: var(--color-success-light);
    color: var(--color-success);
    border: 1px solid var(--color-success);
  }
</style>

<script type="module">
  // Import Firebase auth functions
  import { createUserWithEmailAndPassword } from '/src/lib/firebase-auth.js'

  const getAuthErrorMessage = (err) => {
    const code = (err && typeof err === 'object' && 'code' in err) ? err.code : ''
    switch (code) {
      case 'auth/email-already-in-use':
        return 'An account with this email already exists.'
      case 'auth/invalid-email':
        return 'Please enter a valid email address.'
      case 'auth/weak-password':
        return 'Password is too weak. Please choose a stronger password.'
      case 'auth/operation-not-allowed':
        return 'Email/password sign up is currently disabled.'
      default:
        return 'Sign-up failed. Please try again.'
    }
  }

  // Initialize signup form when page loads
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('signupForm')
    if (!(form instanceof HTMLFormElement)) return

    const errorDiv = document.getElementById('error-message')
    const successDiv = document.getElementById('success-message')

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const formData = new FormData(form)
      const email = String(formData.get('email') || '')
      const password = String(formData.get('password') || '')

      try {
        await createUserWithEmailAndPassword(email, password)

        if (successDiv instanceof HTMLElement) {
          successDiv.textContent = 'Account created successfully! Redirecting to login...'
          successDiv.style.display = 'block'
        }
        if (errorDiv instanceof HTMLElement) {
          errorDiv.style.display = 'none'
        }
        form.reset()

        // Redirect to login after 3 seconds
        setTimeout(() => {
          window.location.href = '/login/'
        }, 3000)
      } catch (error) {
        const msg = getAuthErrorMessage(error)
        console.error('Signup error:', error)
        if (errorDiv instanceof HTMLElement) {
          errorDiv.textContent = msg
          errorDiv.style.display = 'block'
        }
        if (successDiv instanceof HTMLElement) {
          successDiv.style.display = 'none'
        }
      }
    })
  })
</script>