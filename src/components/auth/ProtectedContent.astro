---
export interface Props {
  fallback?: string;
  showLoginButton?: boolean;
  loginPrompt?: string;
}

const {
  fallback = 'Please sign in to view this content.',
  showLoginButton = true,
  loginPrompt = 'Sign In to Continue'
} = Astro.props
---

<!-- Container that will be dynamically populated -->
<div id="protected-container" class="protected-container">
  <!-- Default fallback content (shown while checking auth) -->
  <div id="auth-checking" class="auth-checking">
    <p>Checking authentication...</p>
  </div>

  <!-- Login prompt (will be shown if not authenticated) -->
  <div id="login-prompt" class="login-prompt" style="display: none;">
    <h2>Authentication Required</h2>
    <p>{fallback}</p>
    {showLoginButton && (
      <button id="protected-login-btn" class="auth-button">{loginPrompt}</button>
    )}
  </div>

  <!-- Protected content slot (will be populated if authenticated) -->
  <div id="protected-content" class="protected-content" style="display: none;">
    <slot />
  </div>
</div>

<script>
  import authManager from '../../utils/auth-client.js'

class ProtectedContentManager {
    constructor() {
      this.container = document.getElementById('protected-container')
    this.checkingEl = document.getElementById('auth-checking')
    this.loginPromptEl = document.getElementById('login-prompt')
    this.protectedContentEl = document.getElementById('protected-content')
    this.loginBtn = document.getElementById('protected-login-btn')

    this.init()
  }

    async init() {
      try {
        // Wait for auth manager to initialize
        await authManager.init()

      // Check authentication status
      await this.updateContent()

      // Listen for auth state changes
      window.addEventListener('authStateChanged', () => this.updateContent())

      // Bind login button if it exists
      if (this.loginBtn) {
          this.loginBtn.addEventListener('click', () => authManager.login())
      }
      } catch (error) {
        console.error('ProtectedContent: Initialization failed:', error)
      this.showLoginPrompt()
    }
    }

    async updateContent() {
      if (authManager.isAuthenticated) {
        this.showProtectedContent()
    } else {
        this.showLoginPrompt()
    }
    }

    showProtectedContent() {
      // Hide other states
      if (this.checkingEl) this.checkingEl.style.display = 'none'
    if (this.loginPromptEl) this.loginPromptEl.style.display = 'none'

    // Show protected content
    if (this.protectedContentEl) {
        this.protectedContentEl.style.display = 'block'

      // Populate any user info spans
      const userSpans = this.protectedContentEl.querySelectorAll('[data-auth-user]')
      userSpans.forEach(span => {
          if (authManager.user) {
            span.textContent = authManager.user.name || authManager.user.email || 'User'
        }
        })
    }
    }

    showLoginPrompt() {
      // Hide other states
      if (this.checkingEl) this.checkingEl.style.display = 'none'
    if (this.protectedContentEl) this.protectedContentEl.style.display = 'none'

    // Show login prompt
    if (this.loginPromptEl) this.loginPromptEl.style.display = 'block'
  }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    new ProtectedContentManager()
})
</script>

<style>
  .protected-container {
    width: 100%;
  }

  .auth-checking {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-secondary, #666);
    font-style: italic;
  }

  .login-prompt {
    text-align: center;
    padding: 2rem;
    border: 1px solid var(--color-border, #ccc);
    border-radius: 8px;
    margin: 2rem 0;
    background: var(--color-background-secondary, #f9f9f9);
  }

  .login-prompt h2 {
    margin-bottom: 1rem;
    color: var(--color-text-primary, #333);
  }

  .login-prompt p {
    margin-bottom: 1.5rem;
    color: var(--color-text-secondary, #666);
  }

  .auth-button {
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--Orange700Color, #ff6600);
    background: var(--Orange700Color, #ff6600);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s ease;
  }

  .auth-button:hover {
    background: var(--Orange500Color, #ff8533);
    border-color: var(--Orange500Color, #ff8533);
  }

  .protected-content {
    width: 100%;
  }
</style>