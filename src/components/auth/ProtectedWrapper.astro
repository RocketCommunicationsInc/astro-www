---
export interface Props {
  fallback?: string;
  showLoginButton?: boolean;
}

const {
  fallback = 'Please sign in to view this content.',
  showLoginButton = true
} = Astro.props
---

<!-- Protected wrapper that handles conditional rendering -->
<div class="protected-wrapper" data-protected-wrapper>
  <!-- Loading state -->
  <div class="auth-loading" data-auth-loading>
    <p>Loading...</p>
  </div>

  <!-- Login required state -->
  <div class="login-required" data-login-required style="display: none;">
    <div class="login-prompt">
      <h2>Authentication Required</h2>
      <p>{fallback}</p>
      {showLoginButton && (
        <button class="login-btn" data-login-trigger>Sign In</button>
      )}
    </div>
  </div>

  <!-- Protected content (initially hidden) -->
  <div class="protected-content" data-protected-content style="display: none;">
    <slot />
  </div>
</div>

<script>
  import authManager from '../../utils/auth-client.js'

function initProtectedWrapper() {
    const wrappers = document.querySelectorAll('[data-protected-wrapper]')

  wrappers.forEach(async (wrapper) => {
      const loadingEl = wrapper.querySelector('[data-auth-loading]')
    const loginRequiredEl = wrapper.querySelector('[data-login-required]')
    const protectedContentEl = wrapper.querySelector('[data-protected-content]')
    const loginBtn = wrapper.querySelector('[data-login-trigger]')

    // Bind login button
    if (loginBtn) {
        loginBtn.addEventListener('click', () => authManager.login())
    }

      async function updateVisibility() {
        try {
          await authManager.init()

        if (authManager.isAuthenticated) {
            // Show protected content, hide others
            if (loadingEl) loadingEl.style.display = 'none'
          if (loginRequiredEl) loginRequiredEl.style.display = 'none'
          if (protectedContentEl) {
              protectedContentEl.style.display = 'block'

            // Update any user info elements
            const userElements = protectedContentEl.querySelectorAll('[data-auth-user]')
            userElements.forEach(el => {
                if (authManager.user) {
                  el.textContent = authManager.user.name || authManager.user.email || 'User'
              }
              })
          }
          } else {
            // Show login required, hide others
            if (loadingEl) loadingEl.style.display = 'none'
          if (protectedContentEl) protectedContentEl.style.display = 'none'
          if (loginRequiredEl) loginRequiredEl.style.display = 'block'
        }
        } catch (error) {
          console.error('Protected content error:', error)
        // Show login required on error
        if (loadingEl) loadingEl.style.display = 'none'
        if (protectedContentEl) protectedContentEl.style.display = 'none'
        if (loginRequiredEl) loginRequiredEl.style.display = 'block'
      }
      }

      // Initial update
      updateVisibility()

    // Listen for auth changes
    window.addEventListener('authStateChanged', updateVisibility)
  })
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', initProtectedWrapper)
</script>

<style>
  .protected-wrapper {
    width: 100%;
  }

  .auth-loading {
    text-align: center;
    padding: 1rem;
    color: #666;
    font-style: italic;
  }

  .login-prompt {
    text-align: center;
    padding: 2rem;
    border: 1px solid var(--color-border, #ddd);
    border-radius: 8px;
    background: var(--color-background-secondary, #f9f9f9);
    margin: 1rem 0;
  }

  .login-prompt h2 {
    margin: 0 0 1rem 0;
    color: var(--color-text-primary, #333);
  }

  .login-prompt p {
    margin: 0 0 1.5rem 0;
    color: var(--color-text-secondary, #666);
  }

  .login-btn {
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--Orange700Color, #ff6600);
    background: var(--Orange700Color, #ff6600);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
  }

  .login-btn:hover {
    background: var(--Orange500Color, #ff8533);
    border-color: var(--Orange500Color, #ff8533);
  }

  .protected-content {
    width: 100%;
  }
</style>