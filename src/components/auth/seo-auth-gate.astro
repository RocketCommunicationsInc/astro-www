---
/**
 * SEO-Friendly Auth Gate Component
 * Loads protected content dynamically via API - never serves it in HTML to search engines
 * Shows appropriate CTAs for unauthenticated users instead
 */

export interface Props {
  contentApiUrl?: string
  redirectUrl?: string
  showLogin?: boolean
  loadingMessage?: string
  loginMessage?: string
  minRole?: string
  fallbackTitle?: string
  fallbackDescription?: string
}

const {
  contentApiUrl,
  redirectUrl = '/auth/login/',
  showLogin = true,
  loadingMessage = 'Loading content...',
  loginMessage = 'Sign in to access this premium content.',
  minRole = 'user',
  fallbackTitle = 'Premium Content Available',
  fallbackDescription = 'This section contains advanced documentation and examples available to authenticated users.'
} = Astro.props
---

<seo-auth-gate
  data-content-api-url={contentApiUrl}
  data-redirect-url={redirectUrl}
  data-show-login={showLogin}
  data-loading-message={loadingMessage}
  data-login-message={loginMessage}
  data-min-role={minRole}
>
  <!-- What search engines see: SEO-friendly signup CTA -->
  <div class="auth-gate-seo-content" data-slot="seo-content">
    <div class="premium-content-preview">
      <div class="premium-header">
        <div class="premium-badge">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Premium Content
        </div>
        <h3>{fallbackTitle}</h3>
        <p>{fallbackDescription}</p>
      </div>

      {showLogin && (
        <div class="auth-actions">
          <a href={`${redirectUrl}?redirect=${encodeURIComponent(Astro.url.pathname)}`}
             class="btn btn-primary"
             data-premium-cta="signin">
            Sign In to Access
          </a>
          <a href="/auth/signup/"
             class="btn btn-secondary"
             data-premium-cta="signup">
            Create Free Account
          </a>
        </div>
      )}
    </div>
  </div>

  <!-- Loading state (only shown during auth check) -->
  <div class="auth-gate-loading" data-slot="loading" style="display: none;">
    <div class="loading-spinner" aria-label={loadingMessage}></div>
    <p>{loadingMessage}</p>
  </div>

  <!-- Authenticated user content (loaded dynamically) -->
  <div class="auth-gate-content" data-slot="content" style="display: none;">
    <!-- Content populated via JavaScript after authentication -->
  </div>

  <!-- Error state -->
  <div class="auth-gate-error" data-slot="error" style="display: none;">
    <div class="error-message">
      <h3>Content Unavailable</h3>
      <p>Sorry, we couldn't load this content right now. Please try again later.</p>
      <button class="btn btn-secondary retry-btn">Try Again</button>
    </div>
  </div>
</seo-auth-gate>

<script>
import { authClient } from '../../auth/client.js'
import { hasRole } from '../../auth/utils.js'

class SEOAuthGateElement extends HTMLElement {
  constructor() {
    super()
    this.contentLoaded = false
    this.initialize()
  }

  initialize() {
    // Get configuration
    this.contentApiUrl = this.dataset.contentApiUrl
    this.redirectUrl = this.dataset.redirectUrl || '/auth/login/'
    this.minRole = this.dataset.minRole || 'user'
    this.showLogin = this.dataset.showLogin === 'true'

    // Get DOM elements
    this.seoContent = this.querySelector('[data-slot="seo-content"]')
    this.loadingSlot = this.querySelector('[data-slot="loading"]')
    this.contentSlot = this.querySelector('[data-slot="content"]')
    this.errorSlot = this.querySelector('[data-slot="error"]')
    this.retryBtn = this.querySelector('.retry-btn')

    // Set up retry functionality
    if (this.retryBtn) {
      this.retryBtn.addEventListener('click', () => {
        this.loadProtectedContent(true)
      })
    }

    // Listen for auth state changes
    this.unsubscribeAuth = authClient.onAuthStateChanged((user) => {
      this.handleAuthStateChange(user)
    })

    // Track CTA interactions
    this.setupAnalytics()
  }

  handleAuthStateChange(user) {
    if (!user) {
      this.showSEOContent()
    } else if (!hasRole(user, this.minRole)) {
      this.showInsufficientPermissions()
    } else {
      this.loadProtectedContent()
    }
  }

  async loadProtectedContent(forceReload = false) {
    if (this.contentLoaded && !forceReload) {
      this.showContent()
      return
    }

    if (!this.contentApiUrl) {
      console.warn('No content API URL provided for protected content')
      this.showSEOContent()
      return
    }

    try {
      this.showLoading()

      const user = authClient.getCurrentUser()
      if (!user) {
        throw new Error('User not authenticated')
      }

      const token = await user.getIdToken()
      const response = await fetch(this.contentApiUrl, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
      }

      const contentData = await response.json()

      if (contentData.html) {
        this.contentSlot.innerHTML = contentData.html
      } else if (contentData.content) {
        this.contentSlot.innerHTML = contentData.content
      } else {
        throw new Error('Invalid content format received')
      }

      this.contentLoaded = true
      this.showContent()

      // Track successful content load
      this.trackEvent('protected_content_loaded', {
        contentApiUrl: this.contentApiUrl,
        timestamp: Date.now()
      })
    } catch (error) {
      console.error('Failed to load protected content:', error)
      this.showError()

      // Track content load failure
      this.trackEvent('protected_content_error', {
        error: error.message,
        contentApiUrl: this.contentApiUrl,
        timestamp: Date.now()
      })
    }
  }

  showSEOContent() {
    this.hideAllSlots()
    if (this.seoContent) {
      this.seoContent.style.display = 'block'
    }
  }

  showLoading() {
    this.hideAllSlots()
    if (this.loadingSlot) {
      this.loadingSlot.style.display = 'flex'
    }
  }

  showContent() {
    this.hideAllSlots()
    if (this.contentSlot) {
      this.contentSlot.style.display = 'block'
    }
  }

  showError() {
    this.hideAllSlots()
    if (this.errorSlot) {
      this.errorSlot.style.display = 'block'
    }
  }

  showInsufficientPermissions() {
    // For insufficient permissions, show a modified SEO content
    this.showSEOContent()
    const header = this.querySelector('.premium-header h3')
    if (header) {
      header.textContent = 'Access Level Insufficient'
    }
    const description = this.querySelector('.premium-header p')
    if (description) {
      description.textContent = 'Your account does not have the required permissions for this content.'
    }
  }

  hideAllSlots() {
    const slots = [ this.seoContent, this.loadingSlot, this.contentSlot, this.errorSlot ]
    slots.forEach(slot => {
      if (slot) {
        slot.style.display = 'none'
      }
    })
  }

  setupAnalytics() {
    // Track CTA clicks
    this.addEventListener('click', (e) => {
      const cta = e.target.closest('[data-premium-cta]')
      if (cta) {
        const ctaType = cta.dataset.premiumCta
        this.trackEvent('premium_cta_click', {
          ctaType,
          currentUrl: window.location.pathname,
          timestamp: Date.now()
        })
      }
    })

    // Track when SEO content is viewed
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          this.trackEvent('premium_preview_viewed', {
            currentUrl: window.location.pathname,
            authenticated: !!authClient.getCurrentUser(),
            timestamp: Date.now()
          })
          observer.disconnect()
        }
      })
    }, { threshold: 0.5 })

    if (this.seoContent) {
      observer.observe(this.seoContent)
    }
  }

  trackEvent(eventName, properties) {
    // Send to analytics if available
    if (window.gtag) {
      window.gtag('event', eventName, properties)
    }

    // Log for debugging
    console.log(`Analytics: ${eventName}`, properties)

    // Send to your analytics endpoint
    fetch('/api/analytics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ event: eventName, properties })
    }).catch(err => console.warn('Analytics error:', err))
  }

  disconnectedCallback() {
    if (this.unsubscribeAuth) {
      this.unsubscribeAuth()
    }
  }
}

// Define the custom element
if (!customElements.get('seo-auth-gate')) {
  customElements.define('seo-auth-gate', SEOAuthGateElement)
}
</script>

<style>
  seo-auth-gate {
    display: block;
  }

  .auth-gate-seo-content {
    /* This is what search engines will index */
  }

  .premium-content-preview {
    border: 2px dashed var(--color-border, #e5e7eb);
    border-radius: var(--radius-large, 8px);
    padding: 2rem;
    text-align: center;
    background: linear-gradient(135deg,
      rgba(59, 130, 246, 0.05),
      rgba(29, 78, 216, 0.05)
    );
    margin: 2rem 0;
  }

  .premium-header {
    margin-bottom: 2rem;
  }

  .premium-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #000;
    border-radius: var(--radius-base, 6px);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .premium-header h3 {
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
    color: var(--color-text-primary, #111827);
  }

  .premium-header p {
    margin: 0;
    color: var(--color-text-secondary, #6b7280);
    line-height: 1.6;
  }

  .auth-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-base, 6px);
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    font-size: 1rem;
  }

  .btn-primary {
    background: var(--color-primary, #0066cc);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark, #0052a3);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--color-secondary, #6b7280);
    color: white;
  }

  .btn-secondary:hover {
    background: var(--color-secondary-dark, #4b5563);
  }

  .auth-gate-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 2rem;
    text-align: center;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--color-border, #e5e7eb);
    border-top: 4px solid var(--color-primary, #0066cc);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  .auth-gate-error {
    text-align: center;
    padding: 2rem;
  }

  .error-message {
    max-width: 400px;
    margin: 0 auto;
    padding: 2rem;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: var(--radius-large, 8px);
  }

  .error-message h3 {
    color: #dc2626;
    margin-bottom: 1rem;
  }

  .error-message p {
    color: #991b1b;
    margin-bottom: 1.5rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .auth-actions {
      flex-direction: column;
    }

    .premium-content-preview {
      padding: 1.5rem;
      margin: 1rem 0;
    }

    .premium-header h3 {
      font-size: 1.25rem;
    }
  }

  /* High contrast mode */
  @media (prefers-contrast: high) {
    .premium-content-preview {
      border-color: currentColor;
    }

    .loading-spinner {
      border-top-color: currentColor;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .loading-spinner {
      animation: none;
    }

    .btn {
      transition: none;
    }
  }
</style>