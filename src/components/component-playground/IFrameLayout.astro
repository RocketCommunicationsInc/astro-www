---
import { type PlaygroundRecord } from 'project:data/component-playgrounds.record.json'

import './IFrameLayout.css'

import { For } from '@astropub/flow'

import Panelset from './Panelset/Panelset.astro'
import Panel from './Panelset/Panel.astro'
import PanelNav from './PanelNav/PanelNav.astro'
import PanelNavItem from './PanelNav/PanelNavItem.astro'

import Sandbox from './Sandbox.astro'

import Field from './Field/Field.astro'

import ControlMenu from './Control/Menu.astro'
import ControlText from './Control/Text.astro'
import ControlRadio from './Control/Radio.astro'
import ControlRadioGroup from './Control/RadioGroup.astro'
import ControlSwitch from './Control/Switch.astro'
import ControlSlots from './Control/Slots.astro'

const attrs = Astro.props as PlaygroundRecord

const defaultExample = attrs.examples[0]

const getNPMURL = (path: string) => `https://cdn.jsdelivr.net/npm/${path}`

// const addDependency = (tag: string, constructor: string) => [
// 	`import{${constructor}}from'${getNPMURL(`@astrouxds/astro-web-components@7.9.2/dist/components/${tag}.js/+esm`)}'`,
// 	`customElements.get('${tag}')||customElements.define('${tag}',${constructor})`,
// ].join(';')

const scriptContent = [
	`globalThis.$tag=${JSON.stringify(attrs.tag)}`,
	`globalThis.$target=document.querySelector('${attrs.tag}')`,
].join(';')

// scripts that exist on a given example.
const scripts = attrs.examples.filter((example) => example.script).map((example) => example.script).join(';')
---
<html class="dark-theme" lang="en-US">
	<head>
		<title>Playground</title>

		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />

		<link rel="stylesheet" href={getNPMURL('@astrouxds/tokens@1.5.0/dist/css/index.css')} />
		<link rel="stylesheet" href={getNPMURL('@astrouxds/tokens@1.5.0/dist/css/theme.light.css')} />
		<script src="https://cdn.jsdelivr.net/npm/@astrouxds/astro-web-components/dist/astro-web-components/astro-web-components.esm.js" />

		<script type="module" set:html={scriptContent}></script>
	</head>

	<body>
		<main class="app">
			<section class="sandbox-area">
				<Sandbox class={attrs.align ? `align-${attrs.align} dark-theme` : 'dark-theme'} set:html={
					defaultExample.code
				} />
				{
					attrs.style
						? <style set:html={attrs.style} />
					: null
				}
				{
					scripts
						? <script set:html={scripts} /> : null
				}
			</section>

			<section class="control-area">
				<Panelset>{
					// examples panel
					attrs.examples.length > 1
						? (
							<Panel label="Examples">
								<Field type="menu" property="example:variant" hiddenlabel>
									<ControlRadioGroup for="sandbox:example">{
										<For of={attrs.examples!}>{(example) => (
											<ControlRadio for="sandbox:example" value={example.code} selected={example === defaultExample ? '' : null} set:text={example.name} />
										)}</For>
									}</ControlRadioGroup>
								</Field>
							</Panel>
						)
					: null
				}
				{	// Properties Panel
					Array.isArray(attrs.fields) && attrs.fields.length > 0
						? (
							<Panel label="Properties">
								<For of={attrs.fields!}>{(field) => (
									<Field label={field.attribute} note={field.note}>{
										// Select Menu Control
										field.kind === 'menu'
											? <ControlMenu for={field.property}>{
												<For of={field.options}>{(option) => (
													<option selected={option === field.value} set:text={option} />
												)}</For>
											}</ControlMenu>

										// Radio Group Control
										: field.kind === 'radio-group'
											? <ControlRadioGroup for={field.property}>{
												<For of={field.options}>{(option) => (
													<ControlRadio for={field.property} value={option.value} selected={option.value === field.value ? '' : null} set:text={option.label} />
												)}</For>
											}</ControlRadioGroup>

										// Switch Control
										: field.kind === 'switch'
											? <ControlSwitch for={field.property} checked={field.checked} />

										// Text Control
										: field.kind === 'text'
											? <ControlText for={field.property} value={field.value} />

										// display nothing and continue
										: null
									}</Field>
								)}</For>
							</Panel>
						)
					: null
				}
					<!--Slots are generated by script. when there are no slots the script hides the slot panel. -->
					<Panel label="Slots">
						<Field type="slots" label={attrs.tag} property="slots:example" hiddenlabel>
							<ControlSlots for="slots:examples"></ControlSlots>
							<script>
								import 'project:components/component-playground/Control/Slots.ts'
							</script>
						</Field>
					</Panel>
				</Panelset>
			</section>
			<section class="panel-nav-area">
				<!--Panel Activation Buttons-->
				<PanelNav>
					<PanelNavItem data-nav-item="Examples" />
					<PanelNavItem data-nav-item="Properties" />
					<PanelNavItem data-nav-item="Slots" />
				</PanelNav>
			</section>
		</main>
	</body>
</html>
<script>
import './IFrameLayout.ts'
</script>