---
// Auth navigation component that updates based on client-side auth state
---

<auth-nav-component>
  <div id="auth-nav" class="auth-nav">
    <!-- This will be populated by JavaScript -->
  </div>
</auth-nav-component>

<style>
  .auth-nav {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .auth-nav a {
    padding: 0.5rem 1rem;
    border-radius: var(--EdgeRadius);
    text-decoration: none;
    color: var(--PrimaryColor);
    transition: background-color 0.2s;
  }

  .auth-nav a:hover {
    background-color: var(--SurfaceSelectedColor);
  }

  .auth-nav .btn-primary {
    background-color: var(--InteractiveColor);
    color: var(--InverseColor);
  }

  .auth-nav .btn-primary:hover {
    background-color: var(--InteractiveHoverColor);
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .sign-out-btn {
    background: transparent;
    border: 1px solid var(--InteractiveMutedColor);
    color: var(--PrimaryColor);
    padding: 0.25rem 0.5rem;
    border-radius: var(--EdgeRadius);
    font-size: 0.75rem;
    cursor: pointer;
  }

  .sign-out-btn:hover {
    border-color: var(--InteractiveColor);
    color: var(--InteractiveColor);
  }
</style>

<script type="module">
  // Import Firebase auth helpers (centralized wrappers)
  import { onAuthStateChanged, signOut } from '../../lib/firebase-auth.js'

  // Initialize auth nav when page loads
  document.addEventListener('DOMContentLoaded', () => {

    class AuthNavComponent extends HTMLElement {
      constructor() {
        super()
        this.checkAuthState()

        // Listen for auth state changes and update links
        // @ts-ignore - suppress implicit any for callback param in JS context
        onAuthStateChanged((user) => {
          this.updateAuthNav(user)
        })
      }

      async checkAuthState() {
        try {
          // The onAuthStateChanged listener will handle initial state
          this.updateAuthNav(null)
        } catch (error) {
          console.error('Error checking auth state:', error)
          this.updateAuthNav(null)
        }
      }

  // Update the nav UI based on whether a user is signed in
  // We insert user email via textContent to avoid XSS
  // @ts-ignore - suppress implicit any for method param in JS context
  updateAuthNav(user) {
        const container = this.querySelector('#auth-nav')
        if (!(container instanceof HTMLElement)) return
        if (user) {
          // User is logged in
          container.innerHTML = `
            <div class="user-info">
              <span id="auth-email"></span>
              <a href="/account/dashboard/">Dashboard</a>
              <button id="signout-btn" class="sign-out-btn">Sign Out</button>
            </div>
          `
          const emailEl = container.querySelector('#auth-email')
          if (emailEl) emailEl.textContent = user.email || 'User'
          const signoutBtn = container.querySelector('#signout-btn')
          if (signoutBtn) {
            signoutBtn.addEventListener('click', async () => {
              try {
                await signOut()
                window.location.href = '/'
              } catch (e) {
                console.error('Error signing out:', e)
              }
            })
          }
        } else {
          // User is not logged in
          container.innerHTML = `
            <a href="/login/">Sign In</a>
            <a href="/signup/" class="btn-primary">Create Account</a>
          `
        }
      }
    }

    // Define the custom element
    if (!customElements.get('auth-nav-component')) {
      customElements.define('auth-nav-component', AuthNavComponent)
    }
  })
</script>